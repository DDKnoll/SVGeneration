<%
// var id = pattern.title.replace(' ','-');
%>
<script type='text/javascript' src='/javascripts/ZeroClipboard.min.js'></script>
<script src="/miniColors/jquery.minicolors.js" type="text/javascript"></script>
<link rel="stylesheet" href="/miniColors/jquery.minicolors.css" />
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.2/jquery-ui.min.js"></script>
<script>
window.jQuery.slider ||
document.write('<script type="text/javascript" src="/javascripts/jquery-ui-1.10.2.custom/js/jquery-ui-1.10.2.custom.min.js"><\/script>');
</script>
<script src="/javascripts/jquery.ui.touch-punch.min.js"></script>

<style type="text/css">
html, body {
  background-color: #e6e6e6;
}

.slider {
  position: relative;
  margin: .5em 0;
  width: 100%;
  display: block;
  background: #bbb;
  height: 7px;
  box-shadow: inset 1px 1px 4px rgba(163, 18, 0, 0.5);
  -webkit-border-radius: 7px;
  -moz-border-radius: 7px;
  -ms-border-radius: 7px;
  -o-border-radius: 7px;
  border-radius: 7px;
}
.slider div.ui-slider-range {
  display: block;
  height: 7px;
  -webkit-border-radius: 7px;
  -moz-border-radius: 7px;
  -ms-border-radius: 7px;
  -o-border-radius: 7px;
  border-radius: 7px;
  -webkit-transition-property: background-color;
  -moz-transition-property: background-color;
  -o-transition-property: background-color;
  transition-property: background-color;
  -webkit-transition-duration: 100ms;
  -moz-transition-duration: 100ms;
  -o-transition-duration: 100ms;
  transition-duration: 100ms;
}
.slider.red div.ui-slider-range {
  background-color: #e69e9b;
  box-shadow: inset 1px 1px 4px rgba(163, 18, 0, 0.5);
}
.slider.red div.ui-slider-range.hilite, .slider.red div.ui-slider-range.dragging {
  background-color: #ffa09b;
}
.slider a.ui-slider-handle {
  position: absolute;
  top: -5px;
  margin-left: -9px;
  z-index: 2;
  height: 16px;
  width: 16px;
  -webkit-border-radius: 20px;
  -moz-border-radius: 20px;
  -ms-border-radius: 20px;
  -o-border-radius: 20px;
  border-radius: 20px;
  background-color: #444;
  border: 0px solid rgba(0, 0, 0, 0.1);
  outline: none;
}

</style>

<script type="text/javascript">
//The state variable takes on the value of params or manual, depending on the editors state.
var state = 'params';
/**
 * updateSVG calls the generate(params) function for the SVG and 
 */
function updateSVG(method){
	var svgText = '';
	var css = '';
	var cssCopy = '';
	if(method == 'params'){
		setState('params');
		var params = [];
		$.each($('input.genInput'),function(index,value){
			if($(value).hasClass('color')){
				params[$(value).attr('id')] = $(value).val().replace('#',''); //Get the color and remove the leading '#'
			}
			else {
				params[$(value).attr('id')] = $(value).val();
			}
		});
		svgText = generate(params);
		css = makeCSS(svgText, 'params');
		$('.main').attr('style',css);
		$('#share').val(makeStaticURL(params));
		
		editor.setValue(svgText);
		cssCopy = "/** To edit this background, follow this link:\n"+makeStaticURL()+"\n*/"+css;
		$('#css-copy').text(cssCopy);
		$('#download-button').attr('href', 'data:image/svg+xml,' +encodeURIComponent(svgText) );
	}
	else if(method == 'manual'){
		setState('manual');
		svgText = editor.getSession().getValue();
		css = makeCSS(svgText, 'manual');
		$('.main').attr('style',css);

		cssCopy = "/** To Decode this SVG image, paste the css here: www.svgeneration.com/tools/base-64-decoder */\n"+css
		$('#css-copy').text(cssCopy);
		$('#download-button').attr('href', 'data:image/svg+xml,' +encodeURIComponent(svgText) );
	}
	$('div.filesize').html('SVG File Size: '+( (svgText).length/1024)+'kb');
}

function setState(newState){
	state = newState;
	if(newState == 'params'){
		$('#share-click').html('Share My Graphic<i class="icon-share"></i>');
	} else if(newState == 'manual'){
		$('#share-click').html('You cannot (yet) share manual graphics.');
	}
}

function makeStaticURL(){
	var url = "http://svgeneration.com/generate/id?";
	var param = '';
	$.each($('input.genInput'),function(index, value){
		param = $(value).val();
		param = param.replace(/#/g,"");
		url += $(value).attr('id')+"="+param+"&";
	});
	return url;
}

<%- pattern.js %>

function makeBase64URL(data){
	return "url('data:image/svg+xml;base64," + window.btoa(data) + "')";
}

function makeCSS(SVGstring, method, encoded){
	var css = '';
	if(encoded != true){
		encoded = true
	}

	<%
	var otherCSS = '';
	if(pattern.css != undefined || pattern.css != null){
		console.log("css: "+pattern.css);
		for(var j = 0; j < pattern.css.length; j++){
			otherCSS += pattern.css[j].name+':'+pattern.css[j].value+';'; 
		}
	}
	%>
	autocss = '<%= otherCSS %>\n';

	// If code method, then use the css from the code box.
	if(method == 'manual'){
		css = CSSeditor.getSession().getValue();
	} else {	
		// If easy method, then update the code css box and use the standard
		css += autocss;
		<% if(pattern.bgColor != undefined || pattern.bgColor != null ){%>
		css += 'background-color: '+$('#<%= pattern.bgColor %>').val()+';';
		<% }%>

		CSSeditor.setValue(css.replace(';',';\n'));
	}
	css += "background-image:"+makeBase64URL(SVGstring)+";\n";
	return css;
}

</script>

<div class="tabs">
	<div show-tab="easy-edit" class="tab selected">
	Easy Edit <i class="icon-equalizer"></i>
	</div>
	<div show-tab="manual-edit" class="tab">
	Code Edit <i class="icon-code"></i>
	</div>
</div>
<div style="clear:both;"></div>
<div id="tab-box">
<div class="tab-box-content" id="easy-edit">
<%

/**
 * Loop over the variables and 
 */
if(pattern.params){
	pattern.params.forEach(function(param){
		if((param.min != undefined) && (param.max != undefined)){
			if( param.step == undefined){
				var range = (param.max - param.min);
				if( range > 100 ) param.step = 1;
				else if( range > 20 ) param.step = .1;
				else if( range > .5 ) param.step = .01;
				else param.step = .001;
			}
		}
		else {
			param.min = 0;
			param.max = 100;
			param.step = 1;
		}
		if(param.type == 'color'){
		%>
		<div class="parameter-control color">
			<label for="<%= param.name %>"><%= param.name %>: </label>
			<input value="" onChange="updateSVG('params')" class="genInput color" id="<%= param.name %>"></input>

			<script type="text/javascript">
			$('INPUT.color').minicolors({
			    animationSpeed: 100,
			    animationEasing: 'swing',
			    change: function(){updateSVG('params');},
			    changeDelay: 0,
			    control: 'hue',
			    defaultValue: '#<%= param.default %>',
			    hide: null,
			    hideSpeed: 100,
			    inline: false,
			    letterCase: 'lowercase',
			    opacity: false,
			    position: 'default',
			    show: null,
			    showSpeed: 100,
			    swatchPosition: 'left',
			    textfield: true,
			    theme: 'default'
			});
			</script>
		<%		
		} else if(param.type == 'int'){

		// The int data type requires a slider, a label, and a text box.
		%>
		<div class="parameter-control int">
			<label for="<%= param.name %>"><%= param.name %>: </label>
			<input value="<%= param.default %>" onkeyup="updateSVG('params')" class="int genInput" id="<%= param.name %>"></input>
        	<div id="<%=param.name%>_slider" class="slider red"></div>		
        	<script type="text/javascript">	
			  $("#<%=param.name%>_slider").slider({
			    orientation: "horizontal",
			    range: "min",
			    min: <%=param.min%>,
			    step: <%=param.step%>,
			    max: <%=param.max%>,
			    value: <%=param.default%>,
			    animate: 800,
			    slide: function( event, ui ) {
			    	$('#<%=param.name%>').val(ui.value);
			    	updateSVG('params');
			    	return true;
			    }
			  });
			 </script>
		<%
		} else if(param.type == 'percent'){

		// The int data type requires a slider, a label, and a text box.
		%>
		<div class="parameter-control int">
			<label for="<%= param.name %>"><%= param.name %>: </label>
			<input value="<%= param.default %>" onkeyup="updateSVG('params')" class="int genInput" id="<%= param.name %>"></input>&nbsp;%
        	<div id="<%=param.name%>_slider" class="slider red"></div>		
        	<script type="text/javascript">	
			  $("#<%=param.name%>_slider").slider({
			    orientation: "horizontal",
			    range: "min",
			    min: <%=param.min%>,
			    step: <%=param.step%>,
			    max: <%=param.max%>,
			    value: <%=param.default%>,
			    animate: 800,
			    slide: function( event, ui ) {
			    	$('#<%=param.name%>').val(ui.value);
			    	updateSVG('params');
			    	return true;
			    }
			  });
			 </script>
		<%
		} else if(param.type == 'expInt'){
		// The expInt data type requires a slider, a label, and a text box.
		// The slider is skewed, so that there is more control over the lower int values.
		%>
		<div class="parameter-control int">
			<label for="<%= param.name %>"><%= param.name %>: </label>
			<input value="<%= param.default %>" onkeyup="updateSVG('params')" class="int genInput" id="<%= param.name %>"></input>
        	<div id="<%=param.name%>_slider" class="slider red"></div>		
        	<script type="text/javascript">	
			  $("#<%=param.name%>_slider").slider({
			    orientation: "horizontal",
			    min: <%=param.min%>,
			    step: <%=param.step%>,
			    max: <%=param.max%>,
			    value: <%=param.default%>,
			    animate: 800,
			    slide: function( event, ui ) {
			    	$('#<%=param.name%>').val(ui.value);
			    	updateSVG('params');
			    	return true;
			    }
			  });
			 </script>
		<%
		} else if(param.type == 'logInt'){
		// The expInt data type requires a slider, a label, and a text box.
		// The slider is skewed, so that there is more control over the upper int values.
		%>
		<div class="parameter-control int">
			<label for="<%= param.name %>"><%= param.name %>: </label>
			<input value="<%= param.default %>" onkeyup="updateSVG('params')" class="int genInput" id="<%= param.name %>"></input>
        	<div id="<%=param.name%>_slider" class="slider red"></div>		
        	<script type="text/javascript">	
			  $("#<%=param.name%>_slider").slider({
			    orientation: "horizontal",
			    range: "min",
			    min: <%=param.min%>,
			    step: <%=param.step%>,
			    max: <%=param.max%>,
			    value: <%=param.default%>,
			    animate: 800,
			    slide: function( event, ui ) {
			    	$('#<%=param.name%>').val(ui.value);
			    	updateSVG('params');
			    	return true;
			    }
			  });
			 </script>
		<%
		} else if(param.type == 'color'){
		%>
		<div class="parameter-control">
			<label for="<%= param.name %>"><%= param.name %>: </label>
			<input value="" onChange="updateSVG('params')" class="genInput" id="<%= param.name %>"></input>
		<%
		}
		%>
		</div>
		<div style="clear:both;"></div>
		<%
	});
} else{

%>
<div>
Easy editing is not yet available for this graphic. You will have to use the manual editor for now...
</div>
<%
}
%>
<div style="clear:both;"></div>
</div>
<div class="tab-box-content" id="manual-edit" style="display:none;">
	<p>Caution: If you switch back to the easy editor, you will lose any manual edits you have made.</p>
	<div id="ace-editor"><textarea id="manual-text" rows="15" ><%= pattern.svg %></textarea></div>
	<h3>CSS</h3>
	<div id="css-editor"><textarea id="manual-text" rows="5" ></textarea></div>
	<p>If you make a custom graphic, then <a href='contact@svgeneration.com' target='_blank'>send it in</a>.  It just might show up in the showcase.</p>
</div>


<div class="divider-light"></div>
<div class="filesize">Filesize: </div>
<div id="additional-links">

	<a class="editor-button" id="download-button" download="<%= pattern.title %>.svg" href="data:image/svg+xml, <%- encodeURIComponent(pattern.svg) %>">Download SVG <i class="icon-download-1"></i></a>
	<div id="share-button"><a class="editor-button" id='share-click'>Share My Graphic<i class="icon-share"></i></a>
		<div id='share-tooltip'>
		<div style='border-bottom: 1px solid #eee;'>
		<a data-clipboard-target="share" id='copy-link'><i class="icon-link"></i> Copy Link</a><input id="share" size='30' value="http://svgeneration.com/generate/<%= id %>">
		</div>
		<div id='facebook-share'>
		<a onclick="
    		window.open('https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent($('#share').val()), 
      'facebook-share-dialog', 
      'width=626,height=436'); 
    return false;"><i class="icon-facebook-squared"></i>Facebook</a></div>
		<div id='twitter-share'>
		<a onclick="
    		window.open('https://twitter.com/share?url='+encodeURIComponent($('#share').val()), 
      'facebook-share-dialog', 
      'width=626,height=436');" ><i class="icon-twitter"></i>Twitter</a><br/></div>
		<!--<div id='facebook-share'><a href=""><i class="icon-mail-alt"></i>E-mail</a><br/></div>-->
		</div>
	</div>

	<a class="editor-button" id="hide-editor">Hide Editor<i class="icon-eye"></i></a>
</div>
<div class="divider-light"></div>
<script type="text/javascript">
$(document).ready(function(){

	//Copy button for sharing tooltip
	var linkCopy = new ZeroClipboard( document.getElementById("copy-link"), {
	  moviePath: "/javascripts/ZeroClipboard.swf"
	} );

	// Sharing tooltip
	$('#share-click').click(function(eventObj){
		//You can't share manual graphics.
		if(state == 'manual') return false;
		if($('#share-tooltip').css('display') == 'none'){
			$('#share-tooltip').css('display', 'block');
			eventObj.stopPropagation();
			$('#share-tooltip').click(function(event){
				event.stopPropagation();
			});
			$('body').click(function(){
				$('#share-tooltip').css('display','none');
			});
		}
	})

	$('#hide-editor').click(function(eventObj){
		$('div.navBox').css('z-index',-100);
		$('.tabs').css('z-index',-100);
		$('#tab-box').css('z-index',-100);
		eventObj.stopPropagation();
		$('body').click(function(){
			$('div.navBox').css('z-index',1);
			$('.tabs').css('z-index',1);
			$('#tab-box').css('z-index',1);
		});
	})
	
})
</script>
<div class='code' id="css-code">
	<h3 class="code-title" id='css-title'>CSS</h3>
	<button id="css-copy-button" class="editor-button" title="Click me to copy to clipboard." data-clipboard-target="css-copy">Copy CSS Code</button>
	<pre id="css-copy">background-image: url('data:image/svg+xml;base64,<%- pattern.base64 %>');</pre>
</div>
<script>
var cssCopy = new ZeroClipboard( document.getElementById("css-copy-button"), {
  moviePath: "/javascripts/ZeroClipboard.swf"
} );
cssCopy.on('complete', function(client, args){
	// The click event is fired regardless of which copy button I click, so I will look for a comment tag.
	// If the comment tag exists than it is the css copy
	if(args.text.search(/\/\*/) >= 0){
		$('#css-copy-button').html('Copied');
		window.setTimeout(function(){$('#css-copy-button').html('Copy CSS Code');}, 1200);
	} else {
		$('#copy-link').html('<i class="icon-link"></i> Copied');
		window.setTimeout(function(){$('#copy-link').html('<i class="icon-link"></i> Copy Link');}, 1200);
	}
});
</script>


<!-- ACE TEXT EDITOR -->
<script src="/ace-builds/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>


<script type="text/javascript">
var manualInit = false;
var editor;

editor = ace.edit("ace-editor");
editor.setTheme("ace/theme/clouds");
editor.getSession().setMode("ace/mode/svg");
editor.setShowInvisibles(false);
editor.setDisplayIndentGuides(true);
editor.setHighlightSelectedWord(true);
editor.getSession().setUseSoftTabs(false);
editor.setHighlightActiveLine(false);
editor.getSession().setUseWrapMode(true);
editor.getSession().setWrapLimit(80);

CSSeditor = ace.edit("css-editor");
CSSeditor.setTheme("ace/theme/clouds");
CSSeditor.setShowInvisibles(false);
CSSeditor.setDisplayIndentGuides(true);
CSSeditor.setHighlightSelectedWord(true);
CSSeditor.getSession().setUseSoftTabs(false);
CSSeditor.setHighlightActiveLine(false);
CSSeditor.getSession().setUseWrapMode(true);
CSSeditor.getSession().setWrapLimit(80);

CSSeditor.on("change", function(e){
	if(CSSeditor.isFocused()){
		updateSVG('manual');
	}
});

editor.on("change", function(e){
	if(editor.isFocused()){
		updateSVG('manual');
	}
});

$('div.tab').click(function(){
	var show = $(this).attr('show-tab');
	$('div.tab-box-content').css('display', 'none');
	$('div#'+show).css('display', 'block');
	$('div.tab').removeClass('selected');
	$(this).addClass('selected');

});

//When the page loads set the background
$(document).ready(function(){
	updateSVG('params');	
});
</script>


<div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'svgen'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>